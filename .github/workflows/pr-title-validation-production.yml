name: PR Title Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-and-block:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Title and Block Invalid PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request.title;
            let body = context.payload.pull_request.body || '';
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            // Fetch PR body if not in payload (e.g., for synchronize events)
            if (!body) {
              try {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                body = pr.data.body || '';
              } catch (error) {
                console.log(`âš ï¸ Could not fetch PR body: ${error.message}`);
              }
            }
            
            console.log(`ğŸ” Validating PR #${prNumber} title: "${title}"`);
            console.log(`ğŸ‘¤ Author: ${prAuthor}`);
            
            // Validation function for checkboxes
            function validateCheckboxes(body) {
              const errors = [];
              
              // Check Pre-deployment steps checkbox
              // Pattern matches: "Pre-deployment steps applicable?" followed by markdown checkboxes "- [x] Yes" and "- [x] Not Applicable"
              const preDeploymentMatch = body.match(/Pre-deployment steps applicable\?[\s\S]*?-\s*\[([xX ])\]\s*Yes[\s\S]*?-\s*\[([xX ])\]\s*Not Applicable/);
              if (!preDeploymentMatch || (!preDeploymentMatch[1].match(/[xX]/) && !preDeploymentMatch[2].match(/[xX]/))) {
                errors.push('Pre-deployment steps applicable checkbox must have either "Yes" or "Not Applicable" selected');
              }
              
              // Check Post-deployment steps checkbox
              const postDeploymentMatch = body.match(/Post-deployment steps applicable\?[\s\S]*?-\s*\[([xX ])\]\s*Yes[\s\S]*?-\s*\[([xX ])\]\s*Not Applicable/);
              if (!postDeploymentMatch || (!postDeploymentMatch[1].match(/[xX]/) && !postDeploymentMatch[2].match(/[xX]/))) {
                errors.push('Post-deployment steps applicable checkbox must have either "Yes" or "Not Applicable" selected');
              }
              
              // Check Code check-in in inventory checkbox
              const codeCheckInMatch = body.match(/Code check-in in inventory\?[\s\S]*?-\s*\[([xX ])\]\s*Yes[\s\S]*?-\s*\[([xX ])\]\s*Not Applicable/);
              if (!codeCheckInMatch || (!codeCheckInMatch[1].match(/[xX]/) && !codeCheckInMatch[2].match(/[xX]/))) {
                errors.push('Code check-in in inventory checkbox must have either "Yes" or "Not Applicable" selected');
              }
              
              if (errors.length > 0) {
                return { valid: false, errors };
              }
              
              return { valid: true };
            }
            
            // Validation function with improved month validation
            function validatePRTitle(title) {
              // Expected format: JIRA Issue ID - Sprint # - Release Month - Team Name
              const titlePattern = /^[A-Z]+-\d+ - Sprint \d+ - [A-Za-z]+ \d{4} - [A-Za-z]+$/;
              
              if (!titlePattern.test(title)) {
                return { valid: false, error: `PR title "${title}" does not match required format` };
              }
              
              const parts = title.split(' - ');
              if (parts.length !== 4) {
                return { valid: false, error: 'PR title must have exactly 4 parts separated by " - "' };
              }
              
              const [jiraId, sprint, releaseMonth, teamName] = parts;
              
              // Validate JIRA ID
              if (!/^[A-Z]+-\d+$/.test(jiraId)) {
                return { valid: false, error: `JIRA ID "${jiraId}" must follow format: EDPEST-1234` };
              }
              
              // Validate Sprint
              if (!/^Sprint \d+$/.test(sprint)) {
                return { valid: false, error: `Sprint "${sprint}" must follow format: Sprint 1.1` };
              }
              
              // Validate Release Month with actual month names
              const validMonths = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December',
                'JANUARY', 'FEBRUARY', 'MARCH', 'APRIL', 'MAY', 'JUNE',
                'JULY', 'AUGUST', 'SEPTEMBER', 'OCTOBER', 'NOVEMBER', 'DECEMBER'
              ];
              
              const monthParts = releaseMonth.split(' ');
              if (monthParts.length !== 2) {
                return { valid: false, error: `Release Month "${releaseMonth}" must follow format: March 2024` };
              }
              
              const [monthName, year] = monthParts;
              if (!validMonths.includes(monthName)) {
                return { valid: false, error: `Release Month "${releaseMonth}" must use a valid month name (e.g., January, February, March, etc.)` };
              }
              
              if (!/^\d{4}$/.test(year)) {
                return { valid: false, error: `Release Month "${releaseMonth}" year must be 4 digits` };
              }
              
              // Validate Team Name
              if (!/^[A-Za-z]+$/.test(teamName)) {
                return { valid: false, error: `Team Name "${teamName}" must be alphanumeric with no spaces` };
              }
              
              return { valid: true };
            }
            
            const titleValidation = validatePRTitle(title);
            const checkboxValidation = validateCheckboxes(body);
            
            const allErrors = [];
            if (!titleValidation.valid) {
              allErrors.push({ type: 'title', error: titleValidation.error });
            }
            if (!checkboxValidation.valid) {
              checkboxValidation.errors.forEach(err => {
                allErrors.push({ type: 'checkbox', error: err });
              });
            }
            
            if (allErrors.length > 0) {
              console.log(`âŒ Validation failed`);
              allErrors.forEach(err => console.log(`  - ${err.type}: ${err.error}`));
              
              const titleErrors = allErrors.filter(e => e.type === 'title');
              const checkboxErrors = allErrors.filter(e => e.type === 'checkbox');
              
              // Create detailed comment explaining the issues
              let comment = `## ğŸš¨ PR BLOCKED: Validation Failed\n\n`;
              
              if (titleErrors.length > 0) {
                comment += `**This Pull Request has been automatically blocked because the title doesn't follow the required naming convention.**\n\n`;
                comment += `### âŒ Current Title:\n\`\`\`\n${title}\n\`\`\`\n\n`;
                comment += `### âœ… Required Format:\n\`\`\`\nJIRA Issue ID - Sprint # - Release Month - Team Name\n\`\`\`\n\n`;
                comment += `### ğŸ”§ Valid Examples:\n`;
                comment += `- \`EDPEST-1234 - Sprint 2.3 - August 2025 - OrderTeam\`\n`;
                comment += `- \`EDPEST-4567 - Sprint 2.4 - August 2025 - SalesTeam\`\n\n`;
                comment += `### âŒ Title Issues:\n`;
                titleErrors.forEach(err => {
                  comment += `- **${err.error}**\n`;
                });
                comment += `\n`;
              }
              
              if (checkboxErrors.length > 0) {
                comment += `### âŒ Missing Checkbox Selections:\n`;
                comment += `**The following checkboxes in the PR template must be completed:**\n\n`;
                checkboxErrors.forEach(err => {
                  comment += `- ${err.error}\n`;
                });
                comment += `\n`;
                comment += `Please ensure all checkboxes in the "Quick Checklist" section have either "Yes" or "Not Applicable" selected.\n\n`;
              }
              
              comment += `### ğŸ› ï¸ How to Fix:\n`;
              if (titleErrors.length > 0) {
                comment += `1. **Edit your PR title** to match the required format\n`;
              }
              if (checkboxErrors.length > 0) {
                comment += `${titleErrors.length > 0 ? '2' : '1'}. **Complete all checkboxes** in the PR template\n`;
              }
              comment += `${titleErrors.length > 0 || checkboxErrors.length > 0 ? (titleErrors.length > 0 && checkboxErrors.length > 0 ? '3' : '2') : '1'}. The validation will automatically re-run when you save the changes\n`;
              comment += `${titleErrors.length > 0 || checkboxErrors.length > 0 ? (titleErrors.length > 0 && checkboxErrors.length > 0 ? '4' : '3') : '2'}. Once all validations pass, the PR will be unblocked\n\n`;
              comment += `---\n`;
              comment += `*This PR will remain in draft mode until all validations pass. Please update the PR and this check will automatically re-run.* ğŸš€\n\n`;
              comment += `@${prAuthor} Please update your PR to proceed.`;
              
              // Add the comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              // Convert PR to draft to prevent merging
              try {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  draft: true
                });
                console.log(`ğŸ”’ Converted PR #${prNumber} to draft mode`);
              } catch (error) {
                console.log(`âš ï¸ Could not convert to draft: ${error.message}`);
              }
              
              // Fail the check to prevent merging
              const errorMessages = allErrors.map(e => e.error).join('; ');
              core.setFailed(`PR validation failed: ${errorMessages}`);
              return false;
              
            } else {
              console.log(`âœ… PR title validation passed!`);
              console.log(`âœ… PR checkbox validation passed!`);
              
              // If PR was previously in draft due to validation issues, convert back to ready
              if (context.payload.pull_request.draft) {
                try {
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    draft: false
                  });
                  console.log(`ğŸ”“ Converted PR #${prNumber} back to ready for review`);
                  
                  // Add success comment
                  await github.rest.issues.createComment({
                    issue_number: prNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `## âœ… PR Validation Passed!
                    
                    Great job @${prAuthor}! Your PR has passed all validations:
                    
                    âœ… **Title Format:** Valid
                    \`\`\`
                    ${title}
                    \`\`\`
                    
                    âœ… **Checkboxes:** All completed
                    
                    This PR is now ready for review. ğŸš€`
                  });
                } catch (error) {
                  console.log(`âš ï¸ Could not convert from draft: ${error.message}`);
                }
              }
              
              return true;
            }
